<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.2//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sm24soft.repository.ItemDetailRepository">
	<resultMap type="com.sm24soft.entity.ItemDetail" id="ItemDetailResultMap"
		extends="com.sm24soft.repository.Repository.BaseResultMap">
		<result column="unit_of_sale" property="unitOfSale" />
		<result column="price" property="price" />
		<result column="number_of_item" property="numberOfItem" />
		<result column="total_price" property="totalPrice" />
		<result column="unit_of_total_price" property="unitOfTotalPrice" />
		<result column="void_item_flg" property="voidItemFlg" />
		
		<association column="purchased_item_id"
			property="purchasedItem"
			javaType="com.sm24soft.entity.Item"
			select="com.sm24soft.repository.ItemRepository.findById" />
		<association column="invoice_number"
			property="originalInvoice"
			javaType="com.sm24soft.entity.Invoice"
			select="com.sm24soft.repository.InvoiceRepository.findById" />
	</resultMap>
	
	<sql id="findItemDetailSQL">
		SELECT `item_detail`.`id`,
		    `item_detail`.`purchased_item_id`,
		    `item_detail`.`unit_of_sale`,
		    `item_detail`.`price`,
		    `item_detail`.`number_of_item`,
		    `item_detail`.`total_price`,
		    `item_detail`.`unit_of_total_price`,
		    `item_detail`.`void_item_flg`,
		    `item_detail`.`invoice_number`,
		    `item_detail`.`delete_flg`,
		    `item_detail`.`created_at`,
		    `item_detail`.`created_user_id`,
		    `item_detail`.`updated_at`,
		    `item_detail`.`updated_user_id`
		FROM `item_detail`
	</sql>
	
	<select id="findById" resultMap="ItemDetailResultMap">
		<include refid="findItemDetailSQL" />
		WHERE `item_detail`.`id` = #{id}
			AND `item_detail`.`delete_flg` = "0";
	</select>
	
	<select id="findAllByParentInvoiceId" resultMap="ItemDetailResultMap">
		<include refid="findItemDetailSQL" />
		WHERE `item_detail`.`invoice_number` = #{id}
			AND `item_detail`.`delete_flg` = "0"
		ORDER BY `item_detail`.`id` ASC;
	</select>
	
	<select id="findAll" resultMap="ItemDetailResultMap">
		<include refid="findItemDetailSQL" />
		WHERE `item_detail`.`delete_flg` = "0"
		ORDER BY `item_detail`.`id` ASC;
	</select>
	
	<insert id="save" parameterType="com.sm24soft.entity.ItemDetail">
		INSERT INTO `item_detail`
		(
			`purchased_item_id`,
			`unit_of_sale`,
			`price`,
			`number_of_item`,
			`total_price`,
			`unit_of_total_price`,
			`void_item_flg`,
			`invoice_number`,
			`delete_flg`,
			`created_at`,
			`created_user_id`,
			`updated_at`,
			`updated_user_id`
		)
		VALUES
		(
			#{purchasedItem.id},
			#{unitOfSale},
			#{price},
			#{numberOfItem},
			#{totalPrice},
			#{unitOfTotalPrice},
			#{voidItemFlg},
			#{originalInvoice.id},
			#{deleteFlg},
			#{createdAt},
			#{createdUserId},
			#{updatedAt},
			#{updatedUserId}
		);
		<selectKey keyProperty="id" resultType="java.lang.String" order="AFTER">
			SELECT LAST_INSERT_ID() AS `id`;
		</selectKey>
	</insert>
	
	<update id="update" parameterType="com.sm24soft.entity.ItemDetail">
		UPDATE `item_detail`
		SET
			`purchased_item_id` = #{purchasedItem.id},
			`unit_of_sale` = #{unitOfSale},
			`price` = #{price},
			`number_of_item` = #{numberOfItem},
			`total_price` = #{totalPrice},
			`unit_of_total_price` = #{unitOfTotalPrice},
			`void_item_flg` = #{voidItemFlg},
			`invoice_number` = #{originalInvoice.id},
			`delete_flg` = #{deleteFlg},
			`updated_at` = NOW(),
			`updated_user_id` = #{updatedUserId}
		WHERE `id` = #{id};
		<selectKey keyProperty="id" resultType="java.lang.String" order="AFTER">
			SELECT LAST_INSERT_ID() AS `id`;
		</selectKey>
	</update>
	
	<delete id="deleteById">
		UPDATE `item_detail`
		SET
			`delete_flg` = "1",
			`updated_at` = NOW()
		WHERE `id` = #{id};
	</delete>
</mapper>